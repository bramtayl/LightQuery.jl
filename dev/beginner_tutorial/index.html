<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Beginner tutorial · LightQuery.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">LightQuery.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Usage and performance notes</a></li><li class="is-active"><a class="tocitem" href>Beginner tutorial</a><ul class="internal"><li><a class="tocitem" href="#Airports-cleaning"><span>Airports cleaning</span></a></li><li><a class="tocitem" href="#Flights-cleaning"><span>Flights cleaning</span></a></li><li><a class="tocitem" href="#Grouping-and-validating-flights"><span>Grouping and validating flights</span></a></li><li><a class="tocitem" href="#Weather-cleaning"><span>Weather cleaning</span></a></li><li><a class="tocitem" href="#Joining-flights-and-weather"><span>Joining flights and weather</span></a></li><li><a class="tocitem" href="#Visibility-vs.-departure-delay"><span>Visibility vs. departure delay</span></a></li></ul></li><li><a class="tocitem" href="../reshaping_tutorial/">Reshaping tutorial</a></li><li><a class="tocitem" href="../interface/">Interface</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Beginner tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Beginner tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/bramtayl/LightQuery.jl/blob/master/docs/src/beginner_tutorial.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Beginner-tutorial"><a class="docs-heading-anchor" href="#Beginner-tutorial">Beginner tutorial</a><a id="Beginner-tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Beginner-tutorial" title="Permalink"></a></h1><p>I&#39;m using the data from the <a href="https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html">dplyr tutorial</a>. The data is in the test folder of this package.</p><p>I created it with the following R code:</p><pre><code class="language-R">library(nycflights13)
setwd(&quot;C:/Users/hp/.julia/dev/LightQuery/test&quot;)
write.csv(airports, &quot;airports.csv&quot;, na = &quot;&quot;, row.names = FALSE)
write.csv(flights, &quot;flights.csv&quot;, na = &quot;&quot;, row.names = FALSE)
write.csv(weathers, &quot;weather.csv&quot;, na = &quot;&quot;, row.names = FALSE)</code></pre><p>First, import some tools we will need and change the working directory.</p><pre><code class="language-julia-repl">julia&gt; using LightQuery

julia&gt; import Compat: Iterators

julia&gt; using Dates: Date, DateTime, Hour

julia&gt; using Base.Iterators: flatten

julia&gt; using Tables: columntable

julia&gt; using TimeZones: Class, Local, TimeZone, ZonedDateTime

julia&gt; using Unitful: °, °F, ft, hr, inch, mbar, mi, minute

julia&gt; cd(joinpath(pkgdir(LightQuery), &quot;test&quot;));
</code></pre><h2 id="Airports-cleaning"><a class="docs-heading-anchor" href="#Airports-cleaning">Airports cleaning</a><a id="Airports-cleaning-1"></a><a class="docs-heading-anchor-permalink" href="#Airports-cleaning" title="Permalink"></a></h2><p>The first step in cleaning up this data is to create a dataset about airports. The airports data crucially contains timezone information which we will need to adjust flight times.</p><p>Use <a href="http://juliadata.github.io/CSV.jl/stable/#CSV.File"><code>CSV.File</code></a> to import the airports data.</p><pre><code class="language-julia-repl">julia&gt; using CSV: File

julia&gt; airports_file = File(&quot;airports.csv&quot;, missingstrings = [&quot;&quot;, &quot;\\N&quot;]);</code></pre><p>You can use <code>Tables.columntable</code> to get the columns of the file. Then, immediately use <a href="../interface/#LightQuery.Rows-Tuple{}"><code>Rows</code></a> to iterate over the rows of the file. <code>columntable</code> is a key entry-point to LightQuery, because so many packages implement the Tables interace.</p><pre><code class="language-julia-repl">julia&gt; airports_file = Rows(; columntable(airports_file)...);</code></pre><p>Let&#39;s read in the first row and try to process it.</p><pre><code class="language-julia-repl">julia&gt; airport = first(airports_file)
(faa = &quot;04G&quot;, name = &quot;Lansdowne Airport&quot;, lat = 41.1304722, lon = -80.6195833, alt = 1044, tz = -5, dst = &quot;A&quot;, tzone = &quot;America/New_York&quot;)</code></pre><p>Next, <a href="../interface/#LightQuery.rename-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>rename</code></a> the variables to be human readable.</p><pre><code class="language-julia-repl">julia&gt; airport = rename(airport,
            airport_code = name&quot;faa&quot;,
            altitude = name&quot;alt&quot;,
            daylight_savings = name&quot;dst&quot;,
            latitude = name&quot;lat&quot;,
            longitude = name&quot;lon&quot;,
            time_zone = name&quot;tzone&quot;,
            time_zone_offset = name&quot;tz&quot;
        )
(name = &quot;Lansdowne Airport&quot;, airport_code = &quot;04G&quot;, altitude = 1044, daylight_savings = &quot;A&quot;, latitude = 41.1304722, longitude = -80.6195833, time_zone = &quot;America/New_York&quot;, time_zone_offset = -5)</code></pre><p>Next, <a href="../interface/#LightQuery.remove-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>remove</code></a> redundant data. This data is associated with timezones, not flights.</p><pre><code class="language-julia-repl">julia&gt; airport = remove(airport,
            name&quot;daylight_savings&quot;,
            name&quot;time_zone_offset&quot;
        )
(name = &quot;Lansdowne Airport&quot;, airport_code = &quot;04G&quot;, altitude = 1044, latitude = 41.1304722, longitude = -80.6195833, time_zone = &quot;America/New_York&quot;)</code></pre><p>Next, add units to some of our variables using <a href="../interface/#LightQuery.transform-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>transform</code></a>.</p><pre><code class="language-julia-repl">julia&gt; airport = transform(airport,
            altitude = airport.altitude * ft,
            latitude = airport.latitude * °,
            longitude = airport.longitude * °
        )
(name = &quot;Lansdowne Airport&quot;, airport_code = &quot;04G&quot;, time_zone = &quot;America/New_York&quot;, altitude = 1044 ft, latitude = 41.1304722°, longitude = -80.6195833°)</code></pre><p>Next, we will write a function for getting a true timezone. This will be useful because the departure and arrival times are in various timezones. Use <a href="../interface/#LightQuery.@if_known-Tuple{Any}"><code>@if_known</code></a> to handle <code>missing</code> data. Note the data contains some <code>LEGACY</code> timezones.</p><pre><code class="language-julia-repl">julia&gt; get_time_zone(time_zone) = TimeZone(
            (@if_known time_zone),
            Class(:STANDARD) | Class(:LEGACY)
        );

julia&gt; get_time_zone(airport.time_zone)
America/New_York (UTC-5/UTC-4)</code></pre><p>Next, put all of our row processing steps together into one function. You can use the all-purpose chaining macro <a href="../interface/#LightQuery.@&gt;-Tuple{Any}"><code>@&gt;</code></a> provided in this package to chain all of these steps together.</p><pre><code class="language-julia-repl">julia&gt; function get_airport(row)
            @&gt; row |&gt;
            rename(_,
                airport_code = name&quot;faa&quot;,
                altitude = name&quot;alt&quot;,
                daylight_savings = name&quot;dst&quot;,
                latitude = name&quot;lat&quot;,
                longitude = name&quot;lon&quot;,
                time_zone = name&quot;tzone&quot;,
                time_zone_offset = name&quot;tz&quot;
            ) |&gt;
            remove(_,
                name&quot;daylight_savings&quot;,
                name&quot;time_zone_offset&quot;,
            ) |&gt;
            transform(_,
                altitude = _.altitude * ft,
                latitude = _.latitude * °,
                longitude = _.longitude * °,
                time_zone = get_time_zone(_.time_zone)
            )
        end;

julia&gt; get_airport(first(airports_file))
(name = &quot;Lansdowne Airport&quot;, airport_code = &quot;04G&quot;, altitude = 1044 ft, latitude = 41.1304722°, longitude = -80.6195833°, time_zone = tz&quot;America/New_York&quot;)</code></pre><p>Use <code>Iterators.map</code> to lazily map this function over each row of the airports file.</p><pre><code class="language-julia-repl">julia&gt; airports = Iterators.map(get_airport, airports_file);</code></pre><p>I will repeat the following sequence of operations many times in this tutorial. Call <a href="../interface/#LightQuery.make_columns-Tuple{Any}"><code>make_columns</code></a> to store the data as columns. Then, because it is useful to view the data as rows, use <a href="../interface/#LightQuery.Rows-Tuple{}"><code>Rows</code></a> to lazily view the data row-wise. You can use <a href="../interface/#LightQuery.Peek-Tuple{Any}"><code>Peek</code></a> to look at the first few rows of data.</p><pre><code class="language-julia-repl">julia&gt; airports = Rows(; make_columns(airports)...);</code></pre><p>You can use <a href="../interface/#LightQuery.index-Tuple{Any, Any}"><code>index</code></a> to be able to quickly retrieve airports by code. This will be helpful later. This is very similar to making a <code>Dict</code>.</p><pre><code class="language-julia-repl">julia&gt; const indexed_airports = index(airports, name&quot;airport_code&quot;);</code></pre><h2 id="Flights-cleaning"><a class="docs-heading-anchor" href="#Flights-cleaning">Flights cleaning</a><a id="Flights-cleaning-1"></a><a class="docs-heading-anchor-permalink" href="#Flights-cleaning" title="Permalink"></a></h2><p>Now that we have built our airports dataset, we can start working on the flights data. We&#39;re following basically the same steps as we did above.</p><pre><code class="language-julia-repl">julia&gt; flights_file =
        @&gt; File(&quot;flights.csv&quot;) |&gt;
        columntable |&gt;
        Rows(; _...);</code></pre><p>Again, we will build a function to clean up a row of data. We will again use the first row to build and test our function. I will skip over several steps that we already used in the airports data: get the first flight, <a href="../interface/#LightQuery.rename-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>rename</code></a>, <a href="../interface/#LightQuery.remove-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>remove</code></a>, and <a href="../interface/#LightQuery.transform-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>transform</code></a> to add units.</p><pre><code class="language-julia-repl">julia&gt; flight =
        @&gt; flights_file |&gt;
        first |&gt;
        rename(_,
            arrival_delay = name&quot;arr_delay&quot;,
            arrival_time = name&quot;arr_time&quot;,
            departure_delay = name&quot;dep_delay&quot;,
            departure_time = name&quot;dep_time&quot;,
            destination = name&quot;dest&quot;,
            scheduled_arrival_time = name&quot;sched_arr_time&quot;,
            scheduled_departure_time = name&quot;sched_dep_time&quot;,
            tail_number = name&quot;tailnum&quot;
        ) |&gt;
        remove(_,
            name&quot;arrival_time&quot;,
            name&quot;departure_time&quot;,
            name&quot;hour&quot;,
            name&quot;minute&quot;,
            name&quot;time_hour&quot;
        ) |&gt;
        transform(_,
            air_time = _.air_time * minute,
            arrival_delay = _.arrival_delay * minute,
            departure_delay = _.departure_delay * minute,
            distance = _.distance * mi
        )
(year = 2013, month = 1, day = 1, carrier = &quot;UA&quot;, flight = 1545, origin = &quot;EWR&quot;, destination = &quot;IAH&quot;, scheduled_arrival_time = 819, scheduled_departure_time = 515, tail_number = &quot;N14228&quot;, air_time = 227 minute, arrival_delay = 11 minute, departure_delay = 2 minute, distance = 1400 mi)</code></pre><p>Let&#39;s find the <code>time_zone</code> of the <code>airport</code> the <code>flight</code> departed from. Use <a href="../interface/#LightQuery.@if_known-Tuple{Any}"><code>@if_known</code></a> to handle <code>missing</code> data.</p><pre><code class="language-julia-repl">julia&gt; airport = @if_known get(indexed_airports, flight.origin, missing)
(name = &quot;Newark Liberty Intl&quot;, airport_code = &quot;EWR&quot;, altitude = 18 ft, latitude = 40.6925°, longitude = -74.168667°, time_zone = tz&quot;America/New_York&quot;)

julia&gt; time_zone = @if_known airport.time_zone
America/New_York (UTC-5/UTC-4)</code></pre><p>Now process the departure time. We are given times as hours and minutes concatenated together. Use <code>divrem(_, 100)</code> to split the <code>scheduled_departure_time</code>.</p><pre><code class="language-julia-repl">julia&gt; divrem(flight.scheduled_departure_time, 100)
(5, 15)</code></pre><p>Let&#39;s build a <code>ZonedDateTime</code> for the departure time.</p><pre><code class="language-julia-repl">julia&gt; ZonedDateTime(
            flight.year,
            flight.month,
            flight.day,
            divrem(flight.scheduled_departure_time, 100)...,
            time_zone
        )
2013-01-01T05:15:00-05:00</code></pre><p>We can combine the steps for creating a ZonedDateTime into one function. Then we can use it for both the departure and the arrival times.</p><pre><code class="language-julia-repl">julia&gt; get_time(indexed_airports, flight, airport, time) =
            ZonedDateTime(
                flight.year,
                flight.month,
                flight.day,
                divrem(time, 100)...,
                @if_known (@if_known get(indexed_airports, airport, missing)).time_zone
            );

julia&gt; get_time(
            indexed_airports,
            flight,
            flight.origin,
            flight.scheduled_departure_time
        )
2013-01-01T05:15:00-05:00</code></pre><p>We also used this function to build the <code>scheduled_arrival_time</code>.</p><pre><code class="language-julia-repl">julia&gt; arrival = get_time(
            indexed_airports,
            flight,
            flight.destination,
            flight.scheduled_arrival_time
        )
2013-01-01T08:19:00-06:00</code></pre><p>Let&#39;s combine all of the flights row processing steps into one function.</p><pre><code class="language-julia-repl">julia&gt; function get_flight(indexed_airports, row)
            @&gt; row |&gt;
            rename(_,
                arrival_delay = name&quot;arr_delay&quot;,
                arrival_time = name&quot;arr_time&quot;,
                departure_delay = name&quot;dep_delay&quot;,
                departure_time = name&quot;dep_time&quot;,
                destination = name&quot;dest&quot;,
                scheduled_arrival_time = name&quot;sched_arr_time&quot;,
                scheduled_departure_time = name&quot;sched_dep_time&quot;,
                tail_number = name&quot;tailnum&quot;
            ) |&gt;
            remove(_,
                name&quot;arrival_time&quot;,
                name&quot;departure_time&quot;,
                name&quot;hour&quot;,
                name&quot;minute&quot;,
                name&quot;time_hour&quot;
            ) |&gt;
            transform(_,
                air_time = _.air_time * minute,
                distance = _.distance * mi,
                departure_delay = _.departure_delay * minute,
                arrival_delay = _.arrival_delay * minute,
                scheduled_departure_time =
                    get_time(indexed_airports, _, _.origin, _.scheduled_departure_time),
                scheduled_arrival_time =
                    get_time(indexed_airports, _, _.destination, _.scheduled_arrival_time)
            ) |&gt;
            remove(_,
                name&quot;year&quot;,
                name&quot;month&quot;,
                name&quot;day&quot;
            )
        end;

julia&gt; get_flight(indexed_airports, first(flights_file))
(carrier = &quot;UA&quot;, flight = 1545, origin = &quot;EWR&quot;, destination = &quot;IAH&quot;, tail_number = &quot;N14228&quot;, air_time = 227 minute, distance = 1400 mi, departure_delay = 2 minute, arrival_delay = 11 minute, scheduled_departure_time = ZonedDateTime(2013, 1, 1, 5, 15, tz&quot;America/New_York&quot;), scheduled_arrival_time = ZonedDateTime(2013, 1, 1, 8, 19, tz&quot;America/Chicago&quot;))</code></pre><p>Again, use <code>Iterators.map</code> to lazily map this function over each row. Here we are using the <a href="../interface/#LightQuery.@_-Tuple{Any}"><code>@_</code></a> macro to create an anonymous function as tersely as possible. Finally, we will again use <a href="../interface/#LightQuery.make_columns-Tuple{Any}"><code>make_columns</code></a> and <a href="../interface/#LightQuery.Rows-Tuple{}"><code>Rows</code></a> to store the data column-wise and view it row-wise. Again use <a href="../interface/#LightQuery.Peek-Tuple{Any}"><code>Peek</code></a> to view the first few rows.</p><pre><code class="language-julia-repl">julia&gt; flights =
        @&gt; flights_file |&gt;
        Iterators.map((@_ get_flight(indexed_airports, _)), _);</code></pre><h2 id="Grouping-and-validating-flights"><a class="docs-heading-anchor" href="#Grouping-and-validating-flights">Grouping and validating flights</a><a id="Grouping-and-validating-flights-1"></a><a class="docs-heading-anchor-permalink" href="#Grouping-and-validating-flights" title="Permalink"></a></h2><p>Now that we have cleaned the data, what should we do with? One simple question we might want to answer is whether the distances between two airports is always the same. If this is not the case, there is an inconsistency in the data. Answering this question will also allow me to show off the grouping features of the package. For both joining and grouping, LightQuery requires your data to be pre-sorted. This is greatly improves performance. Consider keeping your data pre-sorted to begin with!</p><p>Thus, first, we will need to <a href="../interface/#LightQuery.order-Tuple{Any, Any}"><code>order</code></a> flights by <code>origin</code>, <code>destination</code>, and <code>distance</code>. Note that we are using a tuple of <a href="../interface/#LightQuery.Name-Tuple{Any}"><code>Name</code></a>s as a selector function to pass to <code>order</code>. Once the data is in order, we can  <a href="../interface/#LightQuery.Group-Tuple{By}"><code>Group</code></a> <a href="../interface/#LightQuery.By"><code>By</code></a> the same variables. <a href="../interface/#LightQuery.By"><code>By</code></a> is necessary before grouping and joining to tell LightQuery how your data is ordered. All flights with the same origin, destination, and distance will be put into one group.</p><pre><code class="language-julia-repl">julia&gt; paths_grouped =
        @&gt; flights |&gt;
        order(_, (name&quot;origin&quot;, name&quot;destination&quot;, name&quot;distance&quot;)) |&gt;
        Group(By(_, (name&quot;origin&quot;, name&quot;destination&quot;, name&quot;distance&quot;)));
</code></pre><p>Each <a href="../interface/#LightQuery.Group-Tuple{By}"><code>Group</code></a> contains a <a href="../interface/#LightQuery.key-Tuple{Any}"><code>key</code></a> and <a href="../interface/#LightQuery.value-Tuple{Any}"><code>value</code></a>. The <a href="../interface/#LightQuery.key-Tuple{Any}"><code>key</code></a> is what we use to group the rows, and the <a href="../interface/#LightQuery.value-Tuple{Any}"><code>value</code></a> is a group of rows which all have the same key. We can look at the first few rows in a group using <a href="../interface/#LightQuery.Peek-Tuple{Any}"><code>Peek</code></a>.</p><pre><code class="language-julia-repl">julia&gt; path = first(paths_grouped);

julia&gt; key(path)
(origin = &quot;EWR&quot;, destination = &quot;ALB&quot;, distance = 143 mi)

julia&gt; value(path) |&gt; Peek
Showing 4 of 439 rows
| carrier | flight | origin | destination | tail_number |  air_time | distance | departure_delay | arrival_delay |  scheduled_departure_time |    scheduled_arrival_time |
| -------:| ------:| ------:| -----------:| -----------:| ---------:| --------:| ---------------:| -------------:| -------------------------:| -------------------------:|
|      EV |   4112 |    EWR |         ALB |      N13538 | 33 minute |   143 mi |       -2 minute |    -10 minute | 2013-01-01T13:17:00-05:00 | 2013-01-01T14:23:00-05:00 |
|      EV |   3260 |    EWR |         ALB |      N19554 | 36 minute |   143 mi |       34 minute |     40 minute | 2013-01-01T16:21:00-05:00 | 2013-01-01T17:24:00-05:00 |
|      EV |   4170 |    EWR |         ALB |      N12540 | 31 minute |   143 mi |       52 minute |     44 minute | 2013-01-01T20:04:00-05:00 | 2013-01-01T21:12:00-05:00 |
|      EV |   4316 |    EWR |         ALB |      N14153 | 33 minute |   143 mi |        5 minute |    -14 minute | 2013-01-02T13:27:00-05:00 | 2013-01-02T14:33:00-05:00 |</code></pre><p>For the purposes of our analysis, all we need is the <code>key</code>. As always, store the data as columns using <a href="../interface/#LightQuery.make_columns-Tuple{Any}"><code>make_columns</code></a>, lazily view it as rows using <a href="../interface/#LightQuery.Rows-Tuple{}"><code>Rows</code></a>, and use <a href="../interface/#LightQuery.Peek-Tuple{Any}"><code>Peek</code></a> to view the first few rows.</p><pre><code class="language-julia-repl">julia&gt; paths =
        @&gt; paths_grouped |&gt;
        Iterators.map(key, _) |&gt;
        make_columns |&gt;
        Rows(; _ ...);

julia&gt; Peek(paths)
Showing 4 of 226 rows
| origin | destination | distance |
| ------:| -----------:| --------:|
|    EWR |         ALB |   143 mi |
|    EWR |         ANC |  3370 mi |
|    EWR |         ATL |   746 mi |
|    EWR |         AUS |  1504 mi |</code></pre><p>Let&#39;s run our data through a second round of grouping. This time, we will group data only by origin and destination. Theoretically, each group should only be one row long, because the distance between an origin and destination airport should always be the same. Our data is already sorted, so we do not need to sort it again before grouping. Again, use <a href="../interface/#LightQuery.Group-Tuple{By}"><code>Group</code></a> and <a href="../interface/#LightQuery.By"><code>By</code></a> to group the rows. Again, we can pass a tuple of <a href="../interface/#LightQuery.Name-Tuple{Any}"><code>Name</code></a>s as a selector function. Then, for each group, we can find the number of rows it contains.</p><pre><code class="language-julia-repl">julia&gt; path_groups =
        @&gt; paths |&gt;
        Group(By(_, (name&quot;origin&quot;, name&quot;destination&quot;)));</code></pre><p>Let&#39;s create a function to add the number of distinct distances to the <code>key</code>.</p><pre><code class="language-julia-repl">julia&gt; first_path_group = first(path_groups);

julia&gt; key(first_path_group)
(origin = &quot;EWR&quot;, destination = &quot;ALB&quot;)

julia&gt; Peek(value(first_path_group))
| origin | destination | distance |
| ------:| -----------:| --------:|
|    EWR |         ALB |   143 mi |

julia&gt; function with_number((key, value))
            transform(key, number = length(value))
        end;

julia&gt; with_number(first_path_group)
(origin = &quot;EWR&quot;, destination = &quot;ALB&quot;, number = 1)</code></pre><p>We can take a <a href="../interface/#LightQuery.Peek-Tuple{Any}"><code>Peek</code></a> at the first few results.</p><pre><code class="language-julia-repl">julia&gt; distinct_distances =
        @&gt; path_groups |&gt;
        Iterators.map(with_number, _);

julia&gt; Peek(distinct_distances)
Showing at most 4 rows
| origin | destination | number |
| ------:| -----------:| ------:|
|    EWR |         ALB |      1 |
|    EWR |         ANC |      1 |
|    EWR |         ATL |      1 |
|    EWR |         AUS |      1 |</code></pre><p>Let&#39;s see when there are multiple distances for the same path using <code>Iterators.filter</code>. Again, use <a href="../interface/#LightQuery.@_-Tuple{Any}"><code>@_</code></a> to create an anonymous function to pass to <code>Iterators.filter</code>.</p><pre><code class="language-julia-repl">julia&gt; @&gt; distinct_distances |&gt;
        Iterators.filter((@_ _.number != 1), _) |&gt;
        Peek
Showing at most 4 rows
| origin | destination | number |
| ------:| -----------:| ------:|
|    EWR |         EGE |      2 |
|    JFK |         EGE |      2 |</code></pre><p>It looks like there is a consistency with flights which arrive at at the <code>EGE</code> airport. Let&#39;s take a <a href="../interface/#LightQuery.Peek-Tuple{Any}"><code>Peek</code></a> at flights going to <code>&quot;EGE&quot;</code> using <code>Iterators.filter</code>. Again, use <a href="../interface/#LightQuery.@_-Tuple{Any}"><code>@_</code></a> to create an anonymous function to pass to <code>Iterators.filter</code>.</p><pre><code class="language-julia-repl">julia&gt; @&gt; flights |&gt;
        Iterators.filter((@_ _.destination == &quot;EGE&quot;), _) |&gt;
        Peek
Showing at most 4 rows
| carrier | flight | origin | destination | tail_number |   air_time | distance | departure_delay | arrival_delay |  scheduled_departure_time |    scheduled_arrival_time |
| -------:| ------:| ------:| -----------:| -----------:| ----------:| --------:| ---------------:| -------------:| -------------------------:| -------------------------:|
|      UA |   1597 |    EWR |         EGE |      N27733 | 287 minute |  1726 mi |       -2 minute |     13 minute | 2013-01-01T09:28:00-05:00 | 2013-01-01T12:20:00-07:00 |
|      AA |    575 |    JFK |         EGE |      N5DRAA | 280 minute |  1747 mi |       -5 minute |      3 minute | 2013-01-01T17:00:00-05:00 | 2013-01-01T19:50:00-07:00 |
|      UA |   1597 |    EWR |         EGE |      N24702 | 261 minute |  1726 mi |        1 minute |      3 minute | 2013-01-02T09:28:00-05:00 | 2013-01-02T12:20:00-07:00 |
|      AA |    575 |    JFK |         EGE |      N631AA | 260 minute |  1747 mi |        5 minute |     16 minute | 2013-01-02T17:00:00-05:00 | 2013-01-02T19:50:00-07:00 |</code></pre><p>You can see just in these rows that there is an inconsistency in the data. The distance for the first two rows should be the same as the distance for the second two rows.</p><h2 id="Weather-cleaning"><a class="docs-heading-anchor" href="#Weather-cleaning">Weather cleaning</a><a id="Weather-cleaning-1"></a><a class="docs-heading-anchor-permalink" href="#Weather-cleaning" title="Permalink"></a></h2><p>Perhaps I want to know weather influences the departure delay. To do this, I will need to join weather data into the flights data. Start by cleaning the weather data using basically the same steps as above. Get the first row, <a href="../interface/#LightQuery.rename-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>rename</code></a>, <a href="../interface/#LightQuery.remove-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>remove</code></a>, and <a href="../interface/#LightQuery.transform-Tuple{Tuple{Vararg{Tuple{Name, Any}, N}} where N, Vararg{Any, N} where N}"><code>transform</code></a> to add units.</p><pre><code class="language-julia-repl">julia&gt; weathers_file =
        @&gt; File(&quot;weather.csv&quot;) |&gt;
        columntable |&gt;
        Rows(; _...);

julia&gt; function get_weather(indexed_airports, row)
            @&gt; row |&gt;
            rename(_,
                airport_code = name&quot;origin&quot;,
                dew_point = name&quot;dewp&quot;,
                humidity = name&quot;humid&quot;,
                precipitation = name&quot;precip&quot;,
                temperature = name&quot;temp&quot;,
                visibility = name&quot;visib&quot;,
                wind_direction = name&quot;wind_dir&quot;
            ) |&gt;
            transform(_,
                dew_point = _.dew_point * °F,
                humidity = _.humidity / 100,
                precipitation = _.precipitation * inch,
                pressure = _.pressure * mbar,
                temperature = _.temperature * °F,
                visibility = _.visibility * mi,
                wind_direction = _.wind_direction * °,
                wind_gust = _.wind_gust * mi / hr,
                wind_speed = _.wind_speed * mi / hr,
                date_time = ZonedDateTime(
                    _.year,
                    _.month,
                    _.day,
                    _.hour,
                    indexed_airports[_.airport_code].time_zone,
                    1
                )
            ) |&gt;
            remove(_,
                name&quot;year&quot;,
                name&quot;month&quot;,
                name&quot;day&quot;,
                name&quot;hour&quot;
            )
        end;

julia&gt; weathers =
        @&gt; weathers_file |&gt;
        Iterators.map((@_ get_weather(indexed_airports, _)), _);

julia&gt; Peek(weathers)
Showing 4 of 26115 rows
|           time_hour | airport_code | dew_point |           humidity | precipitation |    pressure | temperature | visibility | wind_direction | wind_gust |        wind_speed |                 date_time |
| -------------------:| ------------:| ---------:| ------------------:| -------------:| -----------:| -----------:| ----------:| --------------:| ---------:| -----------------:| -------------------------:|
| 2013-01-01 01:00:00 |          EWR |  26.06 °F |             0.5937 |      0.0 inch | 1012.0 mbar |    39.02 °F |    10.0 mi |           270° |   missing | 10.35702 mi hr^-1 | 2013-01-01T01:00:00-05:00 |
| 2013-01-01 02:00:00 |          EWR |  26.96 °F | 0.6163000000000001 |      0.0 inch | 1012.3 mbar |    39.02 °F |    10.0 mi |           250° |   missing |  8.05546 mi hr^-1 | 2013-01-01T02:00:00-05:00 |
| 2013-01-01 03:00:00 |          EWR |  28.04 °F | 0.6443000000000001 |      0.0 inch | 1012.5 mbar |    39.02 °F |    10.0 mi |           240° |   missing |  11.5078 mi hr^-1 | 2013-01-01T03:00:00-05:00 |
| 2013-01-01 04:00:00 |          EWR |  28.04 °F |             0.6221 |      0.0 inch | 1012.2 mbar |    39.92 °F |    10.0 mi |           250° |   missing | 12.65858 mi hr^-1 | 2013-01-01T04:00:00-05:00 |</code></pre><h2 id="Joining-flights-and-weather"><a class="docs-heading-anchor" href="#Joining-flights-and-weather">Joining flights and weather</a><a id="Joining-flights-and-weather-1"></a><a class="docs-heading-anchor-permalink" href="#Joining-flights-and-weather" title="Permalink"></a></h2><p>I happen to know that the weather data is already sorted by <code>airport_code</code> and <code>hour</code>. However, we will need to presort and group the flights before we can join in the weather file. Joining in LightQuery is never many-to-one; you always need to explicitly group first. This is slightly less convenient but allows some extra flexibility.</p><p><a href="../interface/#LightQuery.order-Tuple{Any, Any}"><code>order</code></a> and <a href="../interface/#LightQuery.Group-Tuple{By}"><code>Group</code></a> <code>flights</code> <a href="../interface/#LightQuery.By"><code>By</code></a> matching variables. We will join the flights to the weather data by rounding down the scheduled departure time of the flight to the nearest hour. Only use data when the <code>departure_delay</code> is present.</p><pre><code class="language-julia-repl">julia&gt; grouped_flights =
        @&gt; flights |&gt;
        Iterators.filter((@_ _.departure_delay !== missing), _) |&gt;
        order(_, (name&quot;origin&quot;, name&quot;scheduled_departure_time&quot;)) |&gt;
        Group(By(_, @_ (_.origin, floor(_.scheduled_departure_time, Hour))));

julia&gt; key(first(grouped_flights))
(&quot;EWR&quot;, ZonedDateTime(2013, 1, 1, 5, tz&quot;America/New_York&quot;))</code></pre><p>An inner join will find pairs rows with matching <a href="../interface/#LightQuery.key-Tuple{Any}"><code>key</code></a>s. Groups of flights are already sorted by <a href="../interface/#LightQuery.key-Tuple{Any}"><code>key</code></a>.</p><pre><code class="language-julia-repl">julia&gt; weathers_to_flights = @&gt; InnerJoin(
            By(weathers, @_ (_.airport_code, _.date_time)),
            By(grouped_flights, key)
        );
</code></pre><p>Let&#39;s look at the first match. This will contain weather data, and a group of flights.</p><pre><code class="language-julia-repl">julia&gt; a_match = first(weathers_to_flights);

julia&gt; weather, (flights_key, flights_value) = a_match;

julia&gt; weather
(time_hour = &quot;2013-01-01 05:00:00&quot;, airport_code = &quot;EWR&quot;, dew_point = 28.04 °F, humidity = 0.6443000000000001, precipitation = 0.0 inch, pressure = 1011.9 mbar, temperature = 39.02 °F, visibility = 10.0 mi, wind_direction = 260°, wind_gust = missing, wind_speed = 12.65858 mi hr^-1, date_time = ZonedDateTime(2013, 1, 1, 5, tz&quot;America/New_York&quot;))

julia&gt; flights_key
(&quot;EWR&quot;, ZonedDateTime(2013, 1, 1, 5, tz&quot;America/New_York&quot;))

julia&gt; Peek(flights_value)
| carrier | flight | origin | destination | tail_number |   air_time | distance | departure_delay | arrival_delay |  scheduled_departure_time |    scheduled_arrival_time |
| -------:| ------:| ------:| -----------:| -----------:| ----------:| --------:| ---------------:| -------------:| -------------------------:| -------------------------:|
|      UA |   1545 |    EWR |         IAH |      N14228 | 227 minute |  1400 mi |        2 minute |     11 minute | 2013-01-01T05:15:00-05:00 | 2013-01-01T08:19:00-06:00 |
|      UA |   1696 |    EWR |         ORD |      N39463 | 150 minute |   719 mi |       -4 minute |     12 minute | 2013-01-01T05:58:00-05:00 | 2013-01-01T07:28:00-06:00 |</code></pre><p>We&#39;re interested in <code>visibility</code> and <code>departure_delay</code>. We have one row of weather data on the left but multiple flights on the right. Thus, for each flight, we will need to add in the weather data we are interested in.</p><pre><code class="language-julia-repl">julia&gt; visibility = weather.visibility;

julia&gt; Iterators.map((@_ (
            visibility = visibility,
            departure_delay = _.departure_delay
        )), flights_value) |&gt;
        Peek
| visibility | departure_delay |
| ----------:| ---------------:|
|    10.0 mi |        2 minute |
|    10.0 mi |       -4 minute |</code></pre><p>We will need to conduct these steps for each match. So put them together into a function.</p><pre><code class="language-julia-repl">julia&gt; function interested_in(a_match)
            weather, (flights_key, flights_value) = a_match
            visibility = weather.visibility
            Iterators.map((@_ (
                visibility = visibility,
                departure_delay = _.departure_delay
            )), flights_value)
        end;

julia&gt; Peek(interested_in(a_match))
| visibility | departure_delay |
| ----------:| ---------------:|
|    10.0 mi |        2 minute |
|    10.0 mi |       -4 minute |</code></pre><p>For each match, we are returning several rows. Use <code>Base.Iterators.flatten</code> to unnest data and get a single iterator of rows. Collect the result.</p><pre><code class="language-julia-repl">julia&gt; data =
        @&gt; weathers_to_flights |&gt;
        Iterators.map(interested_in, _) |&gt;
        flatten |&gt;
        make_columns |&gt;
        Rows(; _...);

julia&gt; Peek(data)
Showing 4 of 326993 rows
| visibility | departure_delay |
| ----------:| ---------------:|
|    10.0 mi |        2 minute |
|    10.0 mi |       -4 minute |
|    10.0 mi |       -5 minute |
|    10.0 mi |       -2 minute |</code></pre><h2 id="Visibility-vs.-departure-delay"><a class="docs-heading-anchor" href="#Visibility-vs.-departure-delay">Visibility vs. departure delay</a><a id="Visibility-vs.-departure-delay-1"></a><a class="docs-heading-anchor-permalink" href="#Visibility-vs.-departure-delay" title="Permalink"></a></h2><p>Now we can finally answer the question we are interested in. How does visibility affect <code>departure_delay</code>? First, let&#39;s group by visibility.</p><pre><code class="language-julia-repl">julia&gt; by_visibility =
        @&gt; data |&gt;
        order(_, name&quot;visibility&quot;) |&gt;
        Group(By(_, name&quot;visibility&quot;));

julia&gt; visibility_group = first(by_visibility);

julia&gt; key(visibility_group)
0.0 mi

julia&gt; value(visibility_group) |&gt; Peek
Showing 4 of 87 rows
| visibility | departure_delay |
| ----------:| ---------------:|
|     0.0 mi |       -5 minute |
|     0.0 mi |       -1 minute |
|     0.0 mi |       -8 minute |
|     0.0 mi |       -7 minute |</code></pre><p>For each group, we can calculate the mean <code>departure_delay</code>.</p><pre><code class="language-julia-repl">julia&gt; using Statistics: mean

julia&gt; @&gt; visibility_group |&gt;
        value |&gt;
        Iterators.map(name&quot;departure_delay&quot;, _) |&gt;
        mean
32.252873563218394 minute</code></pre><p>Now run it for all the groups.</p><pre><code class="language-julia-repl">julia&gt; get_mean_departure_delay(visibility_group) = (
            visibility = key(visibility_group),
            mean_departure_delay =
                (@&gt; visibility_group |&gt;
                    value |&gt;
                    Iterators.map(name&quot;departure_delay&quot;, _) |&gt;
                    mean),
            count = length(value(visibility_group))
        );

julia&gt; @&gt; by_visibility |&gt;
            Iterators.map(get_mean_departure_delay, _) |&gt;
            Peek(_, 20)
Showing at most 20 rows
| visibility |      mean_departure_delay |  count |
| ----------:| -------------------------:| ------:|
|     0.0 mi | 32.252873563218394 minute |     87 |
|    0.06 mi |               22.2 minute |     85 |
|    0.12 mi |  50.69975186104218 minute |    403 |
|    0.25 mi | 20.481110254433307 minute |   1297 |
|     0.5 mi |   32.5890826383624 minute |   1319 |
|    0.75 mi |  30.06759906759907 minute |    429 |
|     1.0 mi |  32.24348473566642 minute |   1343 |
|    1.25 mi | 53.187845303867405 minute |    181 |
|     1.5 mi |  25.90661478599222 minute |   1542 |
|    1.75 mi | 43.333333333333336 minute |    132 |
|     2.0 mi | 22.701923076923077 minute |   2912 |
|     2.5 mi |  21.18074398249453 minute |   2285 |
|     3.0 mi |   21.2113218731476 minute |   3374 |
|     4.0 mi |  19.48311444652908 minute |   2132 |
|     5.0 mi |  21.10387902695595 minute |   4563 |
|     6.0 mi | 19.807032301480483 minute |   5944 |
|     7.0 mi | 19.208963745361118 minute |   7006 |
|     8.0 mi |  19.98660103910309 minute |   7314 |
|     9.0 mi | 18.762949476558944 minute |  10985 |
|    10.0 mi | 10.951549367828692 minute | 273660 |</code></pre><p>This data suggests that low visibility levels lead to larger departure delays, on average.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Usage and performance notes</a><a class="docs-footer-nextpage" href="../reshaping_tutorial/">Reshaping tutorial »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Thursday 19 November 2020 19:41">Thursday 19 November 2020</span>. Using Julia version 1.6.0-DEV.1527.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
